var AMDEvaluator,AMDReturnsNothingError,AbstractMethodError,BasicEvaluator,CJSEvaluator,ChangesInWindowError,ExportsViolationError,Loader,NoSourceError,PollutionEvaluator,RawEvaluator,ReturnPollutionError,Storage,ThisPollutionError,UndeclaredRequireError,XHR,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};AbstractMethodError=function(_super){function AbstractMethodError(){this.name="AbstractMethodError",this.message="Calling abstract method detected."}return __extends(AbstractMethodError,_super),AbstractMethodError}(Error),UndeclaredRequireError=function(_super){function UndeclaredRequireError(self_name,require_name){this.self_name=self_name,this.require_name=require_name,this.name="UndeclaredRequireError",this.message="Found unreserved attempt to require of `"+this.require_name+"` inside `"+this.self_name+"`"}return __extends(UndeclaredRequireError,_super),UndeclaredRequireError}(Error),ChangesInWindowError=function(_super){function ChangesInWindowError(self_name,props){this.self_name=self_name,this.props=props,this.name="ChangesInWindowError",this.message="During `"+this.self_name+"` loading window object was polluted with: "+props}return __extends(ChangesInWindowError,_super),ChangesInWindowError}(Error),NoSourceError=function(_super){function NoSourceError(key){this.key=key,this.name="NoSourceError",this.message="Module "+this.key+" source was not found in localStorage. Probably it was not loaded."}return __extends(NoSourceError,_super),NoSourceError}(Error),ExportsViolationError=function(_super){function ExportsViolationError(self_name){this.self_name=self_name,this.name="ExportsViolationError",this.message=""}return __extends(ExportsViolationError,_super),ExportsViolationError}(Error),ReturnPollutionError=function(_super){function ReturnPollutionError(self_name,props){this.self_name=self_name,this.props=props,this.name="ReturnPollutionError",this.message=""}return __extends(ReturnPollutionError,_super),ReturnPollutionError}(Error),ThisPollutionError=function(_super){function ThisPollutionError(self_name,props){this.self_name=self_name,this.props=props,this.name="ThisPollutionError",this.message=""}return __extends(ThisPollutionError,_super),ThisPollutionError}(Error),AMDReturnsNothingError=function(_super){function AMDReturnsNothingError(self_name){this.self_name=self_name,this.name="AMDReturnsNothingError",this.message=""}return __extends(AMDReturnsNothingError,_super),AMDReturnsNothingError}(Error),XHR=function(){try{return new XMLHttpRequest}catch(_error){}try{return new ActiveXObject("Msxml3.XMLHTTP")}catch(_error){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(_error){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(_error){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(_error){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(_error){}return null},BasicEvaluator=function(){function BasicEvaluator(options){this.id=options.id,this.source=options.source,this.deps=options.dependencies,this["this"]={},this.window=this.get_window(),this.errors=[]}return BasicEvaluator.prototype.render=function(){throw new AbstractMethodError},BasicEvaluator.prototype.run=function(){var func,result;return func=new Function(this.render()),result=func.call(this),this._check(result),this.errors.length>0?null:this._make()},BasicEvaluator.prototype.get_window=function(){return{__proto__:window}},BasicEvaluator.prototype.get_require=function(){throw new AbstractMethodError},BasicEvaluator.prototype._fail=function(reason){throw this.errors.push(reason),reason},BasicEvaluator.prototype._check=function(){throw new AbstractMethodError},BasicEvaluator.prototype._make=function(){throw new AbstractMethodError},BasicEvaluator}(),CJSEvaluator=function(_super){function CJSEvaluator(options){CJSEvaluator.__super__.constructor.call(this,options),this.module={},this.exports={},this.module.exports=this.exports,this.require=this.get_require()}return __extends(CJSEvaluator,_super),CJSEvaluator.prototype.render=function(){return"return (function(module, exports, require, window) { \n    "+this.source+"; \n}).call(this.this, this.module, this.exports, this.require, this.window);"},CJSEvaluator.prototype.get_require=function(){var require;return require=function(name){var value;return value=this.deps[name],null==value&&this._fail(new UndeclaredRequireError(this.id,name)),value},require.bind(this)},CJSEvaluator.prototype._check=function(result){var this_keys,window_keys;if(window_keys=Object.keys(this.window),0!==window_keys.length)throw new ChangesInWindowError(this.id,window_keys);if(this.exports!==this.module.exports&&0!==Object.keys(this.exports).length)throw new ExportsViolationError(this.id);if(null!=result)throw new ReturnPollutionError(this.id,Object.keys(result));if(this_keys=Object.keys(this["this"]),0!==this_keys.length)throw new ThisPollutionError(this.id,this_keys)},CJSEvaluator.prototype._make=function(){return this.module.exports},CJSEvaluator}(BasicEvaluator),AMDEvaluator=function(_super){function AMDEvaluator(options){AMDEvaluator.__super__.constructor.call(this,options),this.define=this.get_define()}return __extends(AMDEvaluator,_super),AMDEvaluator.prototype.render=function(){return"return (function(define, window) { \n    "+this.source+"; \n}).call(this.this, this.define, this.window);"},AMDEvaluator.prototype.get_define=function(){var define;return define=function(names,func){var deps,name;return deps=function(){var _i,_len,_results;for(_results=[],_i=0,_len=names.length;_len>_i;_i++)name=names[_i],_results.push(this.deps[name]);return _results}.call(this),this.result=func.apply(this["this"],deps)},define.bind(this)},AMDEvaluator.prototype._check=function(result){var this_keys,window_keys;if(window_keys=Object.keys(this.window),0!==window_keys.length)throw new ChangesInWindowError(this.id,window_keys);if(null!=result)throw new ReturnPollutionError(this.id,Object.keys(result));if(this_keys=Object.keys(this["this"]),0!==this_keys.length)throw new ThisPollutionError(this.id,this_keys);if(null==this.result)throw new AMDReturnsNothingError(this.id)},AMDEvaluator.prototype._make=function(){return this.result},AMDEvaluator}(BasicEvaluator),PollutionEvaluator=function(_super){function PollutionEvaluator(){return PollutionEvaluator.__super__.constructor.apply(this,arguments)}return __extends(PollutionEvaluator,_super),PollutionEvaluator.prototype.render=function(){var args,name,names;return names=["window"].concat(function(){var _results;_results=[];for(name in this.deps)_results.push(name);return _results}.call(this)).join(", "),args=["this.this","this.window"].concat(function(){var _results;_results=[];for(name in this.deps)_results.push('this.deps["'+name+'"]');return _results}.call(this)).join(", "),"return (function("+names+") {\n    "+this.source+";\n}).call("+args+");"},PollutionEvaluator.prototype._check=function(result){if(null!=result)throw new ReturnPollutionError(this.id,Object.keys(result))},PollutionEvaluator.prototype.get_window=function(){var name,result,value,_ref;result={__proto__:PollutionEvaluator.__super__.get_window.call(this)},_ref=this.deps;for(name in _ref)value=_ref[name],result[name]=value;return{__proto__:result}},PollutionEvaluator.prototype._make=function(){var name,result,value,_ref,_ref1;result={},_ref=this.window;for(name in _ref)__hasProp.call(_ref,name)&&(value=_ref[name],result[name]=value);_ref1=this["this"];for(name in _ref1)__hasProp.call(_ref1,name)&&(value=_ref1[name],result[name]=value);return result},PollutionEvaluator}(BasicEvaluator),RawEvaluator=function(_super){function RawEvaluator(){return RawEvaluator.__super__.constructor.apply(this,arguments)}return __extends(RawEvaluator,_super),RawEvaluator.prototype.render=function(){return this.source},RawEvaluator.prototype._check=function(){},RawEvaluator.prototype.get_window=function(){return window},RawEvaluator.prototype._make=function(){return{}},RawEvaluator}(BasicEvaluator),Storage=function(){function Storage(){}return Storage.prototype.get=function(){throw new AbstractMethodError},Storage.prototype.set=function(){throw new AbstractMethodError},Storage}(),Loader=function(){function Loader(){this._all_modules={},this._modules_running=[],this._current_manifest=null,this._update_started=!1,this._modules_in_update=[],this._new_manifest=null,this._total_size=0,this._loaded_sizes={},this._evaluators={cjs:CJSEvaluator,amd:AMDEvaluator,junk:PollutionEvaluator,raw:RawEvaluator},this.manifest_key=("undefined"!=typeof LOADER_PREFIX&&null!==LOADER_PREFIX?LOADER_PREFIX:"spa")+"::manifest"}return Loader.prototype.make_key=function(module){return("undefined"!=typeof LOADER_PREFIX&&null!==LOADER_PREFIX?LOADER_PREFIX:"spa")+":"+module.md5+":"+module.url},Loader.prototype.get=function(key){return window.localStorage.getItem(key)},Loader.prototype.set=function(key,value){return this.log("storing",key),window.localStorage.setItem(key,value)},Loader.prototype.log=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],console.log.apply(console,args)},Loader.prototype.onUpdateFound=function(){return this.log("onUpdateFound",arguments),this.startUpdate()},Loader.prototype.onUpToDate=function(){return this.log("onUpToDate",arguments)},Loader.prototype.onUpdateFailed=function(){return this.log("onUpdateFailed",arguments)},Loader.prototype.onUpdateCompletted=function(){return this.log("onUpdateCompletted",arguments),!0},Loader.prototype.onModuleBeginDownload=function(){return this.log("onModuleBeginDownload",arguments)},Loader.prototype.onModuleDownloaded=function(){return this.log("onModuleDownloaded",arguments)},Loader.prototype.onModuleDownloadFailed=function(){return this.log("onModuleDownloadFailed",arguments)},Loader.prototype.onModuleDownloadProgress=function(){return this.log("onModuleDownloadProgress",arguments)},Loader.prototype.onTotalDownloadProgress=function(){return this.log("onTotalDownloadProgress",arguments)},Loader.prototype.onEvaluationError=function(){return this.log("onEvaluationError",arguments)},Loader.prototype.onApplicationReady=function(){return this.log("onApplicationReady",arguments),this.checkUpdate()},Loader.prototype.write_fake=function(){var key,manifest,module;return manifest=JSON.parse(FAKE_MANIFEST),this.set(this.manifest_key,FAKE_MANIFEST),module=manifest[0],key=this.make_key(module),this.set(key,FAKE_APP)},Loader.prototype.start=function(){var alias,dep,deps,error,evaluator,key,module,module_source,_i,_len,_ref,_ref1,_ref2;for(this._current_manifest=this.get(this.manifest_key),this.log("Current manifest",this._current_manifest),null==this._current_manifest&&(this.log("Writing fake application"),this.write_fake(),this._current_manifest=this.get(this.manifest_key)),this._cleanUp(),this._modules_running=JSON.parse(this._current_manifest),_ref=this._modules_running,_i=0,_len=_ref.length;_len>_i;_i++){module=_ref[_i],key=this.make_key(module),module_source=this.get(key),null==module_source&&this.onEvaluationError(new NoSourceError(key)),module.source=module_source,deps={},_ref1=module.deps;for(alias in _ref1)dep=_ref1[alias],deps[alias]=this._all_modules[dep];deps.loader=this,evaluator=new this._evaluators[null!=(_ref2=module.type)?_ref2:"cjs"]({id:module.id,source:module.source,dependencies:deps});try{this._all_modules[module.id]=evaluator.run()}catch(_error){error=_error,this.onEvaluationError(error)}}this.onApplicationReady()},Loader.prototype.checkUpdate=function(){var manifest_request;this._update_started||(this.log("Checking for update..."),manifest_request=XHR(),manifest_request.open("GET","manifest.json",!0),manifest_request.overrideMimeType("application/json; charset=utf-8"),manifest_request.onload=function(_this){return function(event){return _this._new_manifest=event.target.response,null!=_this._current_manifest&&md5(_this._current_manifest)===md5(_this._new_manifest)?void _this.onUpToDate():_this.onUpdateFound(event)}}(this),manifest_request.onerror=function(_this){return function(event){return _this.onUpdateFailed(event)}}(this),manifest_request.send())},Loader.prototype.startUpdate=function(){var module,_i,_j,_len,_len1,_ref,_ref1;for(this.log("Starting update..."),this._update_started=!0,this._modules_in_update=JSON.parse(this._new_manifest),this._total_size=0,_ref=this._modules_in_update,_i=0,_len=_ref.length;_len>_i;_i++)module=_ref[_i],this._total_size+=module.size,this._loaded_sizes[module.id]=0;for(_ref1=this._modules_in_update,_j=0,_len1=_ref1.length;_len1>_j;_j++)module=_ref1[_j],this._updateModule(module)},Loader.prototype._updateModule=function(module){var key,module_source;key=this.make_key(module),module_source=this.get(key),null!=module_source?(module.source=module_source,this.onTotalDownloadProgress({loaded:this._getLoadedSize(),total:this._total_size}),this._checkAllUpdated()):this._downloadModule(module)},Loader.prototype._getLoadedSize=function(){var loaded_size,name,size,_ref;loaded_size=0,_ref=this._loaded_sizes;for(name in _ref)size=_ref[name],loaded_size+=size;return loaded_size},Loader.prototype._downloadModule=function(module){var module_request;this.onModuleBeginDownload(module),module_request=XHR(),module_request.open("GET",module.url,!0),module_request.onload=function(_this){return function(event){var key,module_source;return module_source=event.target.response,md5(module_source)!==module.md5&&_this.onModuleDownloadFailed(module,event),key=_this.make_key(module),module.source=module_source,_this.set(key,module_source),_this._loaded_sizes[module.id]=module.size,_this.onModuleDownloaded(event),_this.onTotalDownloadProgress({loaded:_this._getLoadedSize(),total:_this._total_size}),_this._checkAllUpdated()}}(this),module_request.onprogress=function(_this){return function(event){return _this._loaded_sizes[module.id]=event.loaded,_this.onModuleDownloadProgress({loaded:event.loaded,total:module.size}),_this.onTotalDownloadProgress({loaded:_this._getLoadedSize(),total:_this._total_size})}}(this),module_request.onerror=function(_this){return function(event){return _this.onModuleDownloadFailed(module,event)}}(this),module_request.onabort=function(_this){return function(event){return _this.onModuleDownloadFailed(module,event)}}(this),module_request.send()},Loader.prototype._checkAllUpdated=function(){var module,_i,_len,_ref;for(_ref=this._modules_in_update,_i=0,_len=_ref.length;_len>_i;_i++)if(module=_ref[_i],null==module.source)return;this.onUpdateCompletted()&&(this.set(this.manifest_key,this._new_manifest),this._current_manifest=this._new_manifest,this._new_manifest=null,this._cleanUp()),this._update_started=!1,this._modules_in_update=[]},Loader.prototype._cleanUp=function(){var i,key,module,modules,prefix,useful,_i,_ref;for(prefix="undefined"!=typeof LOADER_PREFIX&&null!==LOADER_PREFIX?LOADER_PREFIX:"spa",modules=JSON.parse(this._current_manifest),useful=function(){var _i,_len,_results;for(_results=[],_i=0,_len=modules.length;_len>_i;_i++)module=modules[_i],_results.push(this.make_key(module));return _results}.call(this),useful.push(this.manifest_key),this.log(useful),i=_i=0,_ref=localStorage.length-1;_ref>=0?_ref>=_i:_i>=_ref;i=_ref>=0?++_i:--_i)key=localStorage.key(i),__indexOf.call(useful,key)>=0||(this.log("removing",key),localStorage.removeItem(key))},Loader}(),window.onload=function(){var loader;return loader=new Loader,loader.start(),!0};