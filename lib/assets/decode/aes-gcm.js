(function(){"use strict";var t={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(t){this.toString=function(){return"CORRUPT: "+this.message},this.message=t},invalid:function(t){this.toString=function(){return"INVALID: "+this.message},this.message=t},bug:function(t){this.toString=function(){return"BUG: "+this.message},this.message=t},notReady:function(t){this.toString=function(){return"NOT READY: "+this.message},this.message=t}}};return"undefined"!=typeof module&&module.exports&&(module.exports=t),t.bitArray={bitSlice:function(e,i,r){return e=t.bitArray._shiftRight(e.slice(i/32),32-(31&i)).slice(1),void 0===r?e:t.bitArray.clamp(e,r-i)},extract:function(t,e,i){var r,n=Math.floor(-e-i&31);return r=-32&(e+i-1^e)?t[e/32|0]<<32-n^t[e/32+1|0]>>>n:t[e/32|0]>>>n,r&(1<<i)-1},concat:function(e,i){if(0===e.length||0===i.length){return e.concat(i)}var s=e[e.length-1],a=t.bitArray.getPartial(s);return 32===a?e.concat(i):t.bitArray._shiftRight(i,a,0|s,e.slice(0,e.length-1))},bitLength:function(e){var r,i=e.length;return 0===i?0:(r=e[i-1],32*(i-1)+t.bitArray.getPartial(r))},clamp:function(e,i){if(32*e.length<i){return e}e=e.slice(0,Math.ceil(i/32));var r=e.length;return i=31&i,r>0&&i&&(e[r-1]=t.bitArray.partial(i,e[r-1]&2147483648>>i-1,1)),e},partial:function(t,e,i){return 32===t?e:(i?0|e:e<<32-t)+1099511627776*t},getPartial:function(t){return Math.round(t/1099511627776)||32},equal:function(e,i){if(t.bitArray.bitLength(e)!==t.bitArray.bitLength(i)){return!1}var n,r=0;for(n=0;n<e.length;n++){r|=e[n]^i[n]}return 0===r},_shiftRight:function(e,i,r,n){var s,h,a=0;for(void 0===n&&(n=[]);i>=32;i-=32){n.push(r),r=0}if(0===i){return n.concat(e)}for(s=0;s<e.length;s++){n.push(r|e[s]>>>i),r=e[s]<<32-i}return a=e.length?e[e.length-1]:0,h=t.bitArray.getPartial(a),n.push(t.bitArray.partial(i+h&31,i+h>32?r:n.pop(),1)),n},_xor4:function(t,e){return[t[0]^e[0],t[1]^e[1],t[2]^e[2],t[3]^e[3]]}},t.codec.bytes={fromBits:function(e){var n,s,i=[],r=t.bitArray.bitLength(e);for(n=0;r/8>n;n++){0===(3&n)&&(s=e[n/4]),i.push(s>>>24),s<<=8}return i},toBits:function(e){var r,i=[],n=0;for(r=0;r<e.length;r++){n=n<<8|e[r],3===(3&r)&&(i.push(n),n=0)}return 3&r&&i.push(t.bitArray.partial(8*(3&r),n)),i}},t.codec.utf8String={fromBits:function(e){var n,s,i="",r=t.bitArray.bitLength(e);for(n=0;r/8>n;n++){0===(3&n)&&(s=e[n/4]),i+=String.fromCharCode(s>>>24),s<<=8}return decodeURIComponent(escape(i))},toBits:function(e){e=unescape(encodeURIComponent(e));var r,i=[],n=0;for(r=0;r<e.length;r++){n=n<<8|e.charCodeAt(r),3===(3&r)&&(i.push(n),n=0)}return 3&r&&i.push(t.bitArray.partial(8*(3&r),n)),i}},t.codec.hex={fromBits:function(e){var r,i="";for(r=0;r<e.length;r++){i+=((0|e[r])+0xf00000000000).toString(16).substr(4)}return i.substr(0,t.bitArray.bitLength(e)/4)},toBits:function(e){var i,n,r=[];for(e=e.replace(/\s|0x/g,""),n=e.length,e+="00000000",i=0;i<e.length;i+=8){r.push(0^parseInt(e.substr(i,8),16))}return t.bitArray.clamp(r,4*n)}},t.cipher.aes=function(e){this._tables[0][0][0]||this._precompute();var i,r,n,s,a,h=this._tables[0][4],o=this._tables[1],c=e.length,f=1;if(4!==c&&6!==c&&8!==c){throw new t.exception.invalid("invalid aes key size")}for(this._key=[s=e.slice(0),a=[]],i=c;4*c+28>i;i++){n=s[i-1],(i%c===0||8===c&&i%c===4)&&(n=h[n>>>24]<<24^h[n>>16&255]<<16^h[n>>8&255]<<8^h[255&n],i%c===0&&(n=n<<8^n>>>24^f<<24,f=f<<1^283*(f>>7))),s[i]=s[i-c]^n}for(r=0;i;r++,i--){n=s[3&r?i:i-4],a[r]=4>=i||4>r?n:o[0][h[n>>>24]]^o[1][h[n>>16&255]]^o[2][h[n>>8&255]]^o[3][h[255&n]]}},t.cipher.aes.prototype={encrypt:function(t){return this._crypt(t,0)},decrypt:function(t){return this._crypt(t,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var n,s,a,c,f,u,l,p,g,t=this._tables[0],e=this._tables[1],i=t[4],r=e[4],h=[],o=[];for(n=0;256>n;n++){o[(h[n]=n<<1^283*(n>>7))^n]=n}for(s=a=0;!i[s];s^=c||1,a=o[a]||1){for(l=a^a<<1^a<<2^a<<3^a<<4,l=l>>8^255&l^99,i[s]=l,r[l]=s,u=h[f=h[c=h[s]]],g=16843009*u^65537*f^257*c^16843008*s,p=257*h[l]^16843008*l,n=0;4>n;n++){t[n][s]=p=p<<24^p>>>8,e[n][l]=g=g<<24^g>>>8}}for(n=0;5>n;n++){t[n]=t[n].slice(0),e[n]=e[n].slice(0)}},_crypt:function(e,i){if(4!==e.length){throw new t.exception.invalid("invalid aes block size")}var o,c,f,l,r=this._key[i],n=e[0]^r[0],s=e[i?3:1]^r[1],a=e[2]^r[2],h=e[i?1:3]^r[3],u=r.length/4-2,p=4,g=[0,0,0,0],b=this._tables[i],d=b[0],y=b[1],_=b[2],m=b[3],v=b[4];for(l=0;u>l;l++){o=d[n>>>24]^y[s>>16&255]^_[a>>8&255]^m[255&h]^r[p],c=d[s>>>24]^y[a>>16&255]^_[h>>8&255]^m[255&n]^r[p+1],f=d[a>>>24]^y[h>>16&255]^_[n>>8&255]^m[255&s]^r[p+2],h=d[h>>>24]^y[n>>16&255]^_[s>>8&255]^m[255&a]^r[p+3],p+=4,n=o,s=c,a=f}for(l=0;4>l;l++){g[i?3&-l:l]=v[n>>>24]<<24^v[s>>16&255]<<16^v[a>>8&255]<<8^v[255&h]^r[p++],o=n,n=s,s=a,a=h,h=o}return g}},t.hash.sha256=function(t){this._key[0]||this._precompute(),t?(this._h=t._h.slice(0),this._buffer=t._buffer.slice(0),this._length=t._length):this.reset()},t.hash.sha256.hash=function(e){return(new t.hash.sha256).update(e).finalize()},t.hash.sha256.prototype={blockSize:512,reset:function(){return this._h=this._init.slice(0),this._buffer=[],this._length=0,this},update:function(e){"string"==typeof e&&(e=t.codec.utf8String.toBits(e));var i,r=this._buffer=t.bitArray.concat(this._buffer,e),n=this._length,s=this._length=n+t.bitArray.bitLength(e);for(i=512+n&-512;s>=i;i+=512){this._block(r.splice(0,16))}return this},finalize:function(){var e,i=this._buffer,r=this._h;for(i=t.bitArray.concat(i,[t.bitArray.partial(1,1)]),e=i.length+2;15&e;e++){i.push(0)}for(i.push(Math.floor(this._length/4294967296)),i.push(0|this._length);i.length;){this._block(i.splice(0,16))}return this.reset(),r},_init:[],_key:[],_precompute:function(){function r(t){return 4294967296*(t-Math.floor(t))|0}var i,t=0,e=2;t:for(;64>t;e++){for(i=2;e>=i*i;i++){if(e%i===0){continue t}}8>t&&(this._init[t]=r(Math.pow(e,.5))),this._key[t]=r(Math.pow(e,1/3)),t++}},_block:function(t){var e,i,r,n,s=t.slice(0),a=this._h,h=this._key,o=a[0],c=a[1],f=a[2],u=a[3],l=a[4],p=a[5],g=a[6],b=a[7];for(e=0;64>e;e++){16>e?i=s[e]:(r=s[e+1&15],n=s[e+14&15],i=s[15&e]=(r>>>7^r>>>18^r>>>3^r<<25^r<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+s[15&e]+s[e+9&15]|0),i=i+b+(l>>>6^l>>>11^l>>>25^l<<26^l<<21^l<<7)+(g^l&(p^g))+h[e],b=g,g=p,p=l,l=u+i|0,u=f,f=c,c=o,o=i+(c&f^u&(c^f))+(c>>>2^c>>>13^c>>>22^c<<30^c<<19^c<<10)|0}a[0]=a[0]+o|0,a[1]=a[1]+c|0,a[2]=a[2]+f|0,a[3]=a[3]+u|0,a[4]=a[4]+l|0,a[5]=a[5]+p|0,a[6]=a[6]+g|0,a[7]=a[7]+b|0}},t.misc.hmac=function(e,i){this._hash=i=i||t.hash.sha256;var n,r=[[],[]],s=i.prototype.blockSize/32;for(this._baseHash=[new i,new i],e.length>s&&(e=i.hash(e)),n=0;s>n;n++){r[0][n]=909522486^e[n],r[1][n]=1549556828^e[n]}this._baseHash[0].update(r[0]),this._baseHash[1].update(r[1]),this._resultHash=new i(this._baseHash[0])},t.misc.hmac.prototype.encrypt=t.misc.hmac.prototype.mac=function(e){if(this._updated){throw new t.exception.invalid("encrypt on already updated hmac called!")}return this.update(e),this.digest(e)},t.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]),this._updated=!1},t.misc.hmac.prototype.update=function(t){this._updated=!0,this._resultHash.update(t)},t.misc.hmac.prototype.digest=function(){var t=this._resultHash.finalize(),e=new this._hash(this._baseHash[1]).update(t).finalize();return this.reset(),e},t.misc.pbkdf2=function(e,i,r,n,s){if(r=r||1e3,0>n||0>r){throw t.exception.invalid("invalid params to pbkdf2")}"string"==typeof e&&(e=t.codec.utf8String.toBits(e)),"string"==typeof i&&(i=t.codec.utf8String.toBits(i)),s=s||t.misc.hmac;var h,o,c,f,u,a=new s(e),l=[],p=t.bitArray;for(u=1;32*l.length<(n||1);u++){for(h=o=a.encrypt(p.concat(i,[u])),c=1;r>c;c++){for(o=a.encrypt(o),f=0;f<o.length;f++){h[f]^=o[f]}}l=l.concat(h)}return n&&(l=p.clamp(l,n)),l},t.mode.gcm={name:"gcm",encrypt:function(e,i,r,n,s){var a,h=i.slice(0),o=t.bitArray;return s=s||128,n=n||[],a=t.mode.gcm._ctrMode(!0,e,h,n,r,s),o.concat(a.data,a.tag)},decrypt:function(e,i,r,n,s){var a,o,h=i.slice(0),c=t.bitArray,f=c.bitLength(h);if(s=s||128,n=n||[],f>=s?(o=c.bitSlice(h,f-s),h=c.bitSlice(h,0,f-s)):(o=h,h=[]),a=t.mode.gcm._ctrMode(!1,e,h,n,r,s),!c.equal(a.tag,o)){throw new t.exception.corrupt("gcm: tag doesn't match")}return a.data},_galoisMultiply:function(e,i){var r,n,s,a,h,o,c=t.bitArray,f=c._xor4;for(a=[0,0,0,0],h=i.slice(0),r=0;128>r;r++){for(s=0!==(e[Math.floor(r/32)]&1<<31-r%32),s&&(a=f(a,h)),o=0!==(1&h[3]),n=3;n>0;n--){h[n]=h[n]>>>1|(1&h[n-1])<<31}h[0]=h[0]>>>1,o&&(h[0]=h[0]^225<<24)}return a},_ghash:function(e,i,r){var n,s,a=r.length;for(n=i.slice(0),s=0;a>s;s+=4){n[0]^=4294967295&r[s],n[1]^=4294967295&r[s+1],n[2]^=4294967295&r[s+2],n[3]^=4294967295&r[s+3],n=t.mode.gcm._galoisMultiply(n,e)}return n},_ctrMode:function(e,i,r,n,s,a){{var h,o,c,f,u,l,p,g,b,d,y,_,m=t.bitArray;m._xor4}for(b=r.length,d=m.bitLength(r),y=m.bitLength(n),_=m.bitLength(s),h=i.encrypt([0,0,0,0]),96===_?(o=s.slice(0),o=m.concat(o,[1])):(o=t.mode.gcm._ghash(h,[0,0,0,0],s),o=t.mode.gcm._ghash(h,o,[0,0,Math.floor(_/4294967296),4294967295&_])),c=t.mode.gcm._ghash(h,[0,0,0,0],n),l=o.slice(0),p=c.slice(0),e||(p=t.mode.gcm._ghash(h,c,r)),u=0;b>u;u+=4){l[3]++,f=i.encrypt(l),r[u]^=f[0],r[u+1]^=f[1],r[u+2]^=f[2],r[u+3]^=f[3]}return r=m.clamp(r,d),e&&(p=t.mode.gcm._ghash(h,c,r)),g=[Math.floor(y/4294967296),4294967295&y,Math.floor(d/4294967296),4294967295&d],p=t.mode.gcm._ghash(h,p,g),f=i.encrypt(o),p[0]^=f[0],p[1]^=f[1],p[2]^=f[2],p[3]^=f[3],{tag:m.bitSlice(p,0,a),data:r}}},function(e,i,r){var n;if(e instanceof ArrayBuffer){var s=new Uint8Array(e);n=t.codec.bytes.toBits(s)}else{e instanceof Buffer&&(n=t.codec.bytes.toBits(e))}var a=t.codec.hex.toBits(r.salt),h=t.codec.hex.toBits(r.iv),o=t.misc.pbkdf2(i,a,r.iter).slice(0,r.ks/32),c=new t.cipher.aes(o),f=t.codec.utf8String.toBits(r.auth),u=t.mode.gcm.decrypt(c,n,h,f,r.ts);return t.codec.utf8String.fromBits(u)}})();