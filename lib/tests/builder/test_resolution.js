// Generated by CoffeeScript 1.7.1
var chai, expect, fs, mock, path, spa, yaml, _,
  __hasProp = {}.hasOwnProperty;

fs = require("fs");

mock = require("mock-fs");

spa = require("spa");

yaml = require("js-yaml");

path = require("path");

chai = require("chai");

_ = require("underscore");

expect = chai.expect;

chai.Assertion.addMethod('properties', function(expectedPropertiesObj) {
  var func, key, _results;
  _results = [];
  for (key in expectedPropertiesObj) {
    if (!__hasProp.call(expectedPropertiesObj, key)) continue;
    func = expectedPropertiesObj[key];
    _results.push(func.call(new chai.Assertion(this._obj).property(key)));
  }
  return _results;
});

describe('Building module with unknown dependency', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial: \n    a.js: |\n        var b = require(\"/b\");\n    spa.yaml: |\n        root: \"./\""));
  });
  it('should report unresolved dependency', function() {
    var builder;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    return expect(builder.build.bind(builder)).to["throw"](spa.UnresolvedDependencyError).that.deep.equals(new spa.UnresolvedDependencyError("/a.js", "/b"));
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});

describe('Building module with external dependency', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial: \n    a.js: |\n        var b = require(\"/b\");\n    b.js: |\n        // empty\n    spa.yaml: |\n        root: \"./\"\n        excludes:\n            - /b.js"));
  });
  it('should report dependency out of scope', function() {
    var builder;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    return expect(builder.build.bind(builder)).to["throw"](spa.ExternalDependencyError).has.properties({
      alias: function() {
        return this.equals("/b");
      },
      path: function() {
        return this.equals("/a.js");
      }
    });
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});

describe('Building module with cyclic dependencies', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial:\n    a.js: |\n        var b = require(\"/b\");\n    b.js: |\n        var c = require(\"/c\");\n    c.js: |\n        var d = require(\"/d\");\n    d.js: |\n        var a = require(\"/a\");\n    spa.yaml: |\n        root: \"./\""));
  });
  it('should report loop in dependencies', function() {
    var builder, _loop;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    _loop = new spa.Loop().prepend("/d.js", "/a").prepend("/c.js", "/d").prepend("/b.js", "/c").prepend("/a.js", "/b");
    return expect(builder.build.bind(builder)).to["throw"](spa.CyclicDependenciesError).to.have.property("loop").that.deep.equals(_loop);
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});

describe('Building module with cyclic dependencies and something else', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial: \n    a.js: |\n        // empty\n    b.js: |\n        var a = require(\"/a\");\n    c.js: |\n        var d = require(\"/d\");\n        var b = require(\"/b\");\n    d.js: |\n        var e = require(\"/e\");\n        var f = require(\"/f\");\n        var b = require(\"/b\");\n    e.js: |\n        var c = require(\"/c\");\n        var f = require(\"/f\");\n    f.js: |\n        var a = require(\"/a\");\n    spa.yaml: |\n        root: \"./\""));
  });
  it('should report only loop', function() {
    var builder, _loop;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    _loop = new spa.Loop().prepend("/e.js", "/c").prepend("/d.js", "/e").prepend("/c.js", "/d");
    return expect(builder.build.bind(builder)).to["throw"](spa.CyclicDependenciesError).to.have.property("loop").that.deep.equals(_loop);
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});

describe('Building module with paths rewired', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial: \n    module1:\n        a:\n            c.js: |\n                // empty\n        b.js: |\n            var ac = require(\"./a/c\");\n    module2:\n        e.js: |\n            var a1 = require(\"a1/../b\");\n        d.js: |\n            var a1 = require(\"a1/c\");\n    spa.yaml: |\n        root: \"/testimonial/\"\n        extensions: \n            - .js\n        paths:\n            a1: \"/module1/a\"\n        hosting:\n            \"/(**/*.js)\": \"http://127.0.0.1:8010/$1\"\n        manifest: \"manifest.json\""));
  });
  it('should successfully build', function() {
    var builder, manifest;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    builder.build();
    manifest = JSON.parse(fs.readFileSync("/testimonial/manifest.json"), {
      encoding: "utf8"
    });
    expect(manifest).to.be.an("Array")["with"].length(4);
    expect(manifest[0]).to.have.properties({
      id: function() {
        return this.that.equals("c");
      },
      deps: function() {
        return this.that.deep.equals({});
      }
    });
    expect(manifest[1]).to.have.properties({
      id: function() {
        return this.that.equals("b");
      },
      deps: function() {
        return this.that.deep.equals({
          "./a/c": "c"
        });
      }
    });
    expect(manifest[2]).to.have.properties({
      id: function() {
        return this.that.equals("d");
      },
      deps: function() {
        return this.that.deep.equals({
          "a1/c": "c"
        });
      }
    });
    return expect(manifest[3]).to.have.properties({
      id: function() {
        return this.that.equals("e");
      },
      deps: function() {
        return this.that.deep.equals({
          "a1/../b": "b"
        });
      }
    });
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});

describe('Building module without manifest', function() {
  before(function() {
    this.old_cwd = process.cwd();
    process.chdir("/");
    return mock(yaml.safeLoad("testimonial: \n    a.js: // empty\n    spa.yaml: |\n        root: \"/testimonial/\"\n        extensions: \n            - .js"));
  });
  it('should not produce manifest.json', function() {
    var builder;
    builder = spa.Builder.from_config("/testimonial/spa.yaml");
    builder.build();
    return expect(fs.existsSync("/testimonial/manifest.json")).not.to.be["true"];
  });
  return after(function() {
    mock.restore();
    return process.chdir(this.old_cwd);
  });
});
