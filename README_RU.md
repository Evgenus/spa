#SPA

**S** ingle **P** age **A** pplications сборщик и загрузчик приложений для работы в браузере в условиях оффлайн.

Основная идея сборщика в том что б вычислить зависимости между файлами─моделями в приложении javascript и вычислить корректный порядок загрузки который можно передать специальному загрузчику. Также можно определить список изменяемых файлов и проводить пофайловое обновление. Предпочтительным считается использование модулей в формате `CommonJS`.

Преимущества:

  ─ загружать модули асинхронно не нужно
  ─ не нужно явно писать обертки
  ─ в загрузчике меньше подвижных частей и промежуточных состояний
  ─ нету дублирования данных в кешах и возможных конфликтов
  ─ код загрузчика не смешан с кодом приложения
  ─ можно легко визуализировать процесс загрузки любым способом

## Запуск

Билдер настраивается конфигурационным файлом. Единственный параметр коммандной строки ─ путь к этому файлу. 

```
spa ─c spa.yaml
```

## Настройка

Конфигурационный файл может иметь формат `yaml` или `json`. Он представляет собой словарь с со следующими возможными ключами.

**root** ─ путь к корневому каталогу в котором билдер будет искать файлы. Может задаваться как относительный путь от расположения самого конфигурационного файла.

**extensions** ─ список расширений файлов которые билдер будет рассматривать. По умолчанию равен `[".js"]`

**excludes** ─ список файлов и папок которые исключаются из области видимости сборщика. По умолчанию ─ пуст. Список можно задавать как правила в фомате `wildcard` или `glob`, например `./something/**/test/*.js`. Правила проверяют пути относительно корневого каталога.

**paths** ─ превдонимы путей для использования внутри загружаемого проекта. Имеет формат словаря в котором ключи ─ идентификаторы префиксов─псевдонимов, а значения ─ относительные пути от корневого каталога. Например:

```
root: "/testimonial/"
paths:
    vendor: "/lib/contrib"
```

С таким конфигом в файле `/testimonial/src/a.js` можно использовать модуль `/testimonial/lib/contrib/b.js` написав `require('vendor/b.js')`

**hosting** ─ словарь с правилами для преобразования относительных путей к файлам в их адреса URL. Ключи ─ правила, такие же как в `excludes`, в которых скобками можно выделять части пути; значения ─ формат URL в который подставляются выделеные части. Например:

```
hosting:
    "/lib/(**/*.js)": "http://myapp.com/$1"
```

Файл `/lib/app/main.js` будет загружаться из `http://myapp.com/app/main.js`.

**loaders** ─ словарь правил по которому определяется тип загрузчика модуля. Ключи ─ правила, такие же как в `excludes`; значения ─ типы моделей. Возможные значения типов: `cjs`, `amd`, `junk`, `raw`.

─ _cjs_ ─ модуль имеет формат `CommonJS`
─ _amd_ ─ модуль имеет формат `AMD` или `UMD`.
─ _junk_ ─ модуль пытается модифицировать window.
─ _raw_ ─ module пытается создавать локальные переменные, которые должны попасть в глобальный контекст.

**default_loader** ─ тип загрузчика для тех кто не подошли ни под какое правило. По умолчанию ─ `cjs`.

**manifest** ─ относительный путь к файлу манифеста загрузки. Если путь не указан, то файл не будет создан.

**hash_func** ─ хеш функция используемая для генерации `manifest` и `appcache`. Возможные значения `md5`, `ripemd160`, `sha1`, `sha224`, `sha256`, `sha3`, `sha384`, `sha512`. Значение по умолчанию `md5`.

**pretty** ─ булевый флаг для более красивого содержимого файла `manifest`.

**index** ─ относительный путь к стартовому файлу приложения файлу. Загрузчик вместе со всеми необходимыми частями будет встроен в этот файл. Если путь не указан, то файл не будет создан.

**appcache** ─ относительный путь к `appcache` манифесту `html5`. Если путь не указан, то файл не будет создан.

**cached** ─ список путей к дополнительным файлам, которые должны быть внесены в `appcache`. Адреса для этих файлов вычисляются по правилам описанным в `hosting`.

**assets** ─ словарь путей к дополнительным файлам сборщика, которые могут быть кастомизированы для нужд приложения.

─ appcache_template ─ путь к шаблону для генерации `appcache`. В шаблоне можно использовать список `cached`.
─ index_template ─ путь к шаблону для генерации `index`. В шаблоне можно использовать имена из `assets`. Только не вставляйте шаблон сам в себя :)

Все пути могут быть относительными от текущей рабочей папки приложения.

## События и методы

### load

Метод инициирует загрузку текущей версии приложения.

Возможные события:

* `NoManifest` - событие возникает если нет текущей версии, т.е. приложение небыло ещё загружено или было загружено с ошибками. Как правило в обработчике следует вызвать метод `checkUpdate` для первой загрузки.
* `EvaluationStarted` - событие возникает если попытка загрузки текущей версии приложения возможна.
* `ModuleEvaluated` - событие возникает если модуль удачно был загружен.
* `EvaluationError` - событие возникает если в процессе загрузки модуля возникла ошибка. Дальнейшая загрузка прекращается и событие `ApplicationReady` не возникнет.
* `ApplicationReady` - событие возникает если все модули приложения были успешно загружены. Само приложение может в процессе своей загрузки установить обработчик этого события. Это событие можно считать стартом приложения.

### checkUpdate

Метод инициирует проверку на существование более новой версии приложения. 

* `UpToDate` - событие возникает если текущая версия приложения является также и самой новой.
* `UpdateFound` - событие возникает если найдена более новая версия приложения. Как правило в обработчике стоит вызвать метод `startUpdate` или запросить у пользователя подтверждение перед загрузкой файлов новой версии. Предполагается что в этот момент времени работает текущая версия приложения.
* `UpdateFailed` - событие возникает если не удалось найти более новую версию по каким-то сторонним причинам или манифест новой версии не может быть загружен. Ошибка загрузки манифеста может произойти как в случае если манифест содержит неверные данные, так и в случае если текущая версия загрузчика устарела и не совместима с новым форматом манифеста.

### startUpdate

Метод инициирует скачивание новой версии приложения согласно полученному ранее манифесту.

* `onModuleBeginDownload` - событие возникает когда послан запрос на скачивание модуля.
* `onModuleDownloadProgress` - событие отображает процесс скачивания каждого модуля.
* `onTotalDownloadProgress` - событие отображает общий прогресс скачивания модулей.
* `onModuleDownloadFailed` - событие возникает когда скачивание модуля было прервано или завершилось ошибкой. Например когда не сошлась контрольная сумма.
* `onModuleDownloaded` - событие возникает когда модуль был учпешно скачан.
* `onUpdateCompleted` - событие возникает когда все модули были успешно скачаны. Обработчик __должен вернуть__ `true`, если нужно перейти на новую версию, и `false` если нужно отклонить обновление. Обработчик также может уведомить пользователя о возможности загрузить новую версию или запланировать рестарт приложения. В таком случае новая версия будет загружена следующим вызовом метода `load`. 

## Пример

```yaml
root: "/testimonial/"
index: index.html
appcache: main.appcache
paths:
    vendor: "/lib/contrib"
assets:
    index_template: /assets/index.tmpl
    appcache_template: /assets/appcache.tmpl
hash_func: sha256
cached:
    - /a.js
hosting:
    "/(**/*.*)": "http://127.0.0.1:8010/$1"
```

## Альтернативы

Другие проекты, на которые вам стоило бы обратить внимание:

 * [gluejs](http://mixu.net/gluejs/)
 * [browserbuild](https://github.com/learnboost/browserbuild/)
 * [browserify](http://browserify.org/)

## Разработка

Пишите [задачи](https://github.com/Evgenus/spa/issues). Я открыт для сотрудничества.

### Установка из GitHub

```
npm install git://github.com/Evgenus/spa.git#stable
```

### Структура проекта

```
spa
├───bin                             запускаемый файл
├───bower_components                сторонние компоненты необходимые для работы загрузчика; инсталируются при помощи `bower`
├───lib                             скомпилированный код сборщика 
│   └───assets                      файлы необходимые сборщику для генерации
│       └───hash                    адаптированный код хеш-функций
├───node_modules                    сторонние компоненты необходимые для работы сборщика; инсталируются при помощи `npm`
├───src                             исходный код проекта на языке coffee-script
│   ├───builder                     исходный код сборщика
│   ├───bootstrap                   исходный код стандартных реакций на события и отображения UI
│   └───loader                      исходный код загрузчика
└───tests                           тесты сборщика и загрузчика
```

### Установка зависимостей 

```
npm install
bower install
```

### Компиляция проекта 

```
cake build
```

### Тестирование 

Тесты требуют установки devDependencies! Тесты требуют `Selenium Standalone Server`.

```
npm test
```
